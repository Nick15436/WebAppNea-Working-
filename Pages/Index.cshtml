@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="container-fluid pt-3">

    <div class="row">
        <div class="col-12 glass-panel p-3 rounded d-flex justify-content-between align-items-center">
            <ul class="nav nav-underline mb-0" data-bs-theme="dark">
                @if (ViewData["FavoriteTickers"] is List<string> favorites && favorites.Count > 0)
                {
                    foreach (var symbol in favorites)
                    {
                        <li class="nav-item d-flex align-items-center me-3">
                            <a class="nav-link @(Model.ActiveTicker == symbol ? "active" : "")" href="/?ticker=@symbol">@symbol</a>
                        
                            <form method="post" asp-page-handler="RemoveTicker" class="ms-1">
                                <input type="hidden" name="symbol" value="@symbol" />
                                <button type="submit" class="btn btn-sm btn-link text-white-50 p-0 hover-danger" style="text-decoration: none; font-size: 14px;" title="Remove">✕</button>
                            </form>
                        </li>
                    }
                }
                else
                {
                    <li class="nav-item"><span class="nav-link text-white-50 disabled">No saved companies</span></li>
                }

                <li class="nav-item ms-2">
                    <button class="nav-link text-accent border border-secondary rounded px-3" data-bs-toggle="modal" data-bs-target="#addTickerModal">
                        + Add
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="row mt-4 justify-content-center">
        <div class="col-12">
            @if (Model.ApiDataIsNull)
            {
                <div class="alert alert-warning glass-panel border-0 text-white">
                    Request limit hit. Data displayed is NOT REAL-TIME.
                </div>
            }
            <div id="main" style="width: 100%; height:600px;"></div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 glass-panel text-light p-4 rounded">
            <div class="row">
                
                <div class="col-md-3 border-end border-secondary">
                    <h6 class="text-uppercase text-secondary mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">Market Data</h6>
                    <div class="d-flex align-items-center mb-3">
                        <span class="display-6 fw-bold me-3">@Model.ActiveTicker</span>
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">Weekly</span>
                    </div>
                    <div class="d-flex flex-column gap-1">
                        <div class="d-flex justify-content-between"><span class="text-white-50 small">Timezone</span><span class="small font-monospace">US/Eastern</span></div>
                        <div class="d-flex justify-content-between"><span class="text-white-50 small">Currency</span><span class="small font-monospace">USD</span></div>
                    </div>
                </div>

                <div class="col-md-5 border-end border-secondary px-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-uppercase text-secondary mb-0" style="font-size: 0.75rem; letter-spacing: 1px;">Prediction Model</h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="predictionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                @Model.CurrentPrediction
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark glass-panel" aria-labelledby="predictionDropdown">
                                <li><a class="dropdown-item @(Model.CurrentPrediction == "Naive" ? "active" : "")" href="/?ticker=@Model.ActiveTicker&prediction=Naive">Naive</a></li>
                                <li><a class="dropdown-item @(Model.CurrentPrediction == "MovingAverage" ? "active" : "")" href="/?ticker=@Model.ActiveTicker&prediction=MovingAverage">Simple Moving Average</a></li>
                                <li><a class="dropdown-item @(Model.CurrentPrediction == "LinearRegression" ? "active" : "")" href="/?ticker=@Model.ActiveTicker&prediction=LinearRegression">Linear Regression</a></li>
                                <li><a class="dropdown-item @(Model.CurrentPrediction == "MachineLearningRegression" ? "active" : "")" href="/?ticker=@Model.ActiveTicker&prediction=MachineLearningRegression">ML Regression</a></li>
                                <li><a class="dropdown-item @(Model.CurrentPrediction == "MachineLearningClassification" ? "active" : "")" href="/?ticker=@Model.ActiveTicker&prediction=MachineLearningClassification">ML Classification</a></li>
                                <li><a class="dropdown-item @(Model.CurrentPrediction == "EnsembleModel" ? "active" : "")" href="/?ticker=@Model.ActiveTicker&prediction=EnsembleModel">Ensemble Model</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="p-3 rounded" style="background: rgba(0,0,0,0.3);">
                        <p class="small text-white-50 mb-0">
                            @if (Model.CurrentPrediction == "MachineLearningClassification") { <text>Analyses past trends to classify the next week's move.</text> }
                            else if (Model.CurrentPrediction == "MachineLearningRegression") { <text>Uses the SDCA machine learning algorithm to predict the next week's closing price by analysing the price data from the previous five weeks.</text> }
                            else if (Model.CurrentPrediction == "MovingAverage") { <text>Finds the average values for the 5 most recent datapoints</text> }
                            else if (Model.CurrentPrediction == "Naive") { <text>Assumes that the price will be the same in the future</text> }
                            else if (Model.CurrentPrediction == "EnsembleModel") { <text>All of the models working together (excluding the classification)</text> }
                            else if (Model.CurrentPrediction == "LinearRegression") { <text></text>}
                            else { <text>Select a model to view analysis.</text> }
                        </p>
                    </div>
                </div>

                <div class="col-md-4 ps-4">
                    <h6 class="text-uppercase text-secondary mb-3" style="font-size: 0.75rem; letter-spacing: 1px;">Analysis Results</h6>

                    @if (Model.ClassificationScores != null && Model.ClassificationScores.Length >= 2)
                    {
                        <div class="mb-2">
                            <div class="d-flex justify-content-between small mb-1"><span>Bullish</span><span>@Model.ClassificationScores[1]</span></div>
                            <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                                <div class="progress-bar bg-success" role="progressbar" style="width: @(Model.ClassificationScores[1])%;"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between small mb-1"><span>Bearish</span><span>@Model.ClassificationScores[0]</span></div>
                            <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: @(Model.ClassificationScores[0])%;"></div>
                            </div>
                        </div>
                        @if (Model.ClassificationScores.Length > 2)
                        {
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1"><span>Neutral</span><span>@Model.ClassificationScores[2]</span></div>
                                <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                                    <div class="progress-bar bg-secondary" role="progressbar" style="width: @(Model.ClassificationScores[2])%;"></div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="d-flex align-items-center justify-content-center h-100 text-white-50"><span class="small fst-italic">Select a model to view results...</span></div>
                    }
                </div>

            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    var myChart = echarts.init(document.getElementById('main'), 'dark');
    var option = {
        backgroundColor: 'transparent',
        dataZoom: { type: 'slider' },
        grid: { width: '90%', left: '5%', containLabel: true },
        tooltip: { trigger: 'axis', axisPointer: { type: 'line' } },
        xAxis: { data: @Html.Raw(Model.LabelsData) },
        yAxis: { scale: true, splitLine: { show: false } },
        series: [{
            type: 'candlestick',
            data: @Html.Raw(Model.CandlesData),
            itemStyle: 
                { 
                    color: '#0037da', 
                    color0: '#ffffff', 
                    borderColor: '#0037da', 
                    borderColor0: '#ffffff' 
                }
        }]
    };
    myChart.setOption(option);
    window.addEventListener('resize', myChart.resize);
</script>

<!-- This is the code needed for the popup window when searching for a ticker. -->
<div class="modal fade" id="addTickerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white" style="border: 1px solid rgba(255,255,255,0.1);">
            <div class="modal-header border-0">
                <h5 class="modal-title">Search Companies</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="tickerSearchInput" class="form-control bg-dark text-white border-secondary" placeholder="Type a company name (e.g. Tesla)">
                    <button class="btn btn-primary" type="button" id="btnSearchTicker">Search</button>
                </div>
                <div id="searchResults" class="list-group">
                </div>
            </div>
        </div>
    </div>
</div>